<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CostReports360</title>
    <link href="https://fonts.googleapis.com/css2?family=Amazon+Ember:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overscroll-behavior: none;
        }
        
        body {
            font-family: 'Open Sans', 'Amazon Ember', Arial, sans-serif;
            background: linear-gradient(135deg, #23649c 0%, #1a4d78 100%);
            color: #FFFFFF;
            min-height: 100vh;
            padding: 20px;
            overscroll-behavior: none;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            padding: 40px 0;
            border-bottom: 3px solid #FFFFFF;
            margin-bottom: 40px;
        }

        .logo {
            max-width: 200px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 8px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #FFFFFF;
            font-size: 1.1rem;
        }
        
        .aws-logo {
            color: #FFFFFF;
            font-weight: bold;
        }
        
        .card {
            background: #FFFFFF;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            color: #23649c;
        }
        
        .card h3 {
            color: #23649c;
            font-size: 1.3rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #23649c;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #23649c;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #D5DBDB;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s;
            background: #FFFFFF;
            color: #232F3E;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #23649c;
        }
        
        .month-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .month-selector select {
            flex: 1;
        }
        
        .month-selector .remove-btn {
            background: #D13212;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }
        
        .month-selector .remove-btn:hover {
            background: #A02A0F;
        }
        
        .btn {
            background: #23649c;
            color: #FFFFFF;
            border: none;
            padding: 14px 28px;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .btn:hover {
            background: #1a4d78;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(35, 100, 156, 0.3);
        }
        
        .btn-secondary {
            background: #FFFFFF;
            color: #23649c;
            border: 2px solid #23649c;
        
        .btn-secondary:hover {
            background: #f0f0f0;
        }
        
        .btn-generate {
            width: 100%;
            padding: 18px;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #23649c 0%, #1a4d78 100%);
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        
        .status.success {
            background: #D5F4E6;
            color: #0F5132;
            border: 2px solid #0F5132;
        }
        
        .status.error {
            background: #F8D7DA;
            color: #842029;
            border: 2px solid #842029;
        }
        
        .status.loading {
            background: #FFF3CD;
            color: #664D03;
            border: 2px solid #664D03;
        }
        
        .info-box {
            background: #E8F4F8;
            border-left: 4px solid #23649c;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            color: #23649c;
        }
        
        .info-box strong {
            color: #23649c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://apn-portal.my.salesforce.com/servlet/servlet.ImageServer?id=0150L00000AUiBnQAL&oid=00DE0000000c48tMAA" alt="CloudThat Logo" class="logo">
            <h1>CostReports360</h1>
            <p>Generate detailed AWS cost analysis reports with regional breakdowns</p>
        </div>
        
        <div class="card">
            <h3>Client Information</h3>
            <div class="form-group">
                <label>Client Name</label>
                <input type="text" id="clientName" placeholder="Example Client" required>
            </div>
        </div>
        
        <div class="card">
            <h3>Select Months (2-6 months)</h3>
            <div id="months-container"></div>
            <button class="btn" onclick="addMonth()">+ Add Month</button>
        </div>
        
        <div class="card">
            <h3>Authentication Method</h3>
            <div class="form-group">
                <label>Choose Method</label>
                <select id="authMethod" onchange="toggleAuthMethod()">
                    <option value="credentials">AWS Credentials</option>
                    <option value="role">Cross-Account Role (Recommended)</option>
                </select>
            </div>

            <div id="credentialsAuth">
                <div class="form-group">
                    <label>AWS Access Key ID</label>
                    <input type="text" id="accessKeyId" placeholder="AKIAIOSFODNN7EXAMPLE">
                </div>
                
                <div class="form-group">
                    <label>AWS Secret Access Key</label>
                    <input type="password" id="secretAccessKey" placeholder="wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY">
                </div>
            </div>

            <div id="roleAuth" style="display:none;">
                <div class="info-box">
                    <strong>Step 1:</strong> Download the CloudFormation template and deploy it in your AWS account to create the required role.
                    <br><br>
                    <button class="btn" onclick="downloadTemplate()">ðŸ“¥ Download CloudFormation Template</button>
                    <button class="btn" onclick="downloadManualInstructions()">ðŸ“„ Download Manual Instructions</button>
                </div>
                <br>
                <div class="form-group">
                    <label>Your AWS Account ID (12 digits)</label>
                    <input type="text" id="targetAccountId" placeholder="123456789012" pattern="[0-9]{12}" maxlength="12">
                </div>
            </div>
        </div>
        
        <div class="card">
            <button class="btn btn-generate" onclick="generateReport()">Generate Report</button>
            <div id="status"></div>
        </div>
    </div>

    <script>
        const API_ENDPOINT = 'https://o52tpbmni5.execute-api.ap-south-1.amazonaws.com/prod/generate';
        
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
        
        function createMonthSelector() {
            const div = document.createElement('div');
            div.className = 'month-selector';
            
            const yearSelect = document.createElement('select');
            yearSelect.className = 'year-select';
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= currentYear - 3; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            
            const monthSelect = document.createElement('select');
            monthSelect.className = 'month-select';
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = String(index + 1).padStart(2, '0');
                option.textContent = month;
                monthSelect.appendChild(option);
            });
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = 'âœ•';
            removeBtn.onclick = function() {
                if (document.querySelectorAll('.month-selector').length > 2) {
                    div.remove();
                } else {
                    alert('Minimum 2 months required');
                }
            };
            
            div.appendChild(yearSelect);
            div.appendChild(monthSelect);
            div.appendChild(removeBtn);
            
            return div;
        }
        
        function addMonth() {
            const container = document.getElementById('months-container');
            if (container.children.length >= 6) {
                alert('Maximum 6 months allowed');
                return;
            }
            container.appendChild(createMonthSelector());
        }
        
        function getSelectedMonths() {
            const selectors = document.querySelectorAll('.month-selector');
            const months = [];
            selectors.forEach(selector => {
                const year = selector.querySelector('.year-select').value;
                const month = selector.querySelector('.month-select').value;
                months.push(`${year}-${month}`);
            });
            return months;
        }
        
        function toggleAuthMethod() {
            const method = document.getElementById('authMethod').value;
            const credentialsAuth = document.getElementById('credentialsAuth');
            const roleAuth = document.getElementById('roleAuth');
            
            if (method === 'credentials') {
                credentialsAuth.style.display = 'block';
                roleAuth.style.display = 'none';
            } else {
                credentialsAuth.style.display = 'none';
                roleAuth.style.display = 'block';
            }
        }
        
        function downloadTemplate() {
            const template = `AWSTemplateFormatVersion: '2010-09-09'
Description: CostReports360 Read-Only Role for Cross-Account Access

Parameters:
  TrustedAccountId:
    Type: String
    Description: Account ID where CostReports360 is deployed
    Default: '162290422654'

Resources:
  CostReports360ReadOnlyRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: CostReports360ReadOnlyRole
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::\${TrustedAccountId}:root'
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: CostExplorerReadOnly
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 'ce:GetCostAndUsage'
                  - 'ce:GetCostForecast'
                Resource: '*'

Outputs:
  RoleArn:
    Description: ARN of the created role
    Value: !GetAtt CostReports360ReadOnlyRole.Arn`;
            
            const blob = new Blob([template], { type: 'text/yaml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'costreports360-role.yaml';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function downloadManualInstructions() {
            const instructions = `# Manual Role Creation Instructions for CostReports360

## Prerequisites
- Access to AWS Console
- Administrator permissions in the target AWS account

## Steps to Create the Role via AWS Console

### Step 1: Navigate to IAM

1. Sign in to the AWS Console
2. Go to **IAM** service (search for "IAM" in the top search bar)
3. Click on **Roles** in the left sidebar
4. Click **Create role** button

### Step 2: Configure Trust Relationship

1. Select **AWS account** as the trusted entity type
2. Choose **Another AWS account**
3. Enter the Account ID: **162290422654**
4. Click **Next**

### Step 3: Add Permissions

1. In the permissions policies search box, type: **Cost Explorer**
2. You won't find a pre-built policy, so click **Next** (we'll add inline policy later)
3. Click **Next** again

### Step 4: Name and Create Role

1. Role name: **CostReports360ReadOnlyRole** (must be exact)
2. Description: *Read-only role for CostReports360 cross-account access*
3. Click **Create role**

### Step 5: Add Inline Policy for Cost Explorer

1. Find and click on the newly created role **CostReports360ReadOnlyRole**
2. Go to the **Permissions** tab
3. Click **Add permissions** â†’ **Create inline policy**
4. Click on the **JSON** tab
5. Paste the following policy:

\`\`\`json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ce:GetCostAndUsage",
        "ce:GetCostForecast"
      ],
      "Resource": "*"
    }
  ]
}
\`\`\`

6. Click **Next**
7. Policy name: **CostExplorerReadOnly**
8. Click **Create policy**

### Step 6: Verify the Role

1. Go back to the role details page
2. Verify the **Trust relationships** tab shows Account ID: **162290422654**
3. Verify the **Permissions** tab shows the inline policy **CostExplorerReadOnly**
4. Copy the **Role ARN** for reference (optional)

## Important Notes

- The role name must be exactly **CostReports360ReadOnlyRole**
- The trusted account ID is **162290422654** (where CostReports360 is deployed)
- Ensure Cost Explorer is enabled in your AWS account
- The role grants read-only access to Cost Explorer data only

## Troubleshooting

If you encounter issues:
1. Verify the trust relationship has the correct account ID: **162290422654**
2. Ensure Cost Explorer is enabled in your account (Billing â†’ Cost Explorer)
3. Check that the role name matches exactly: **CostReports360ReadOnlyRole**
4. Verify you have permissions to create IAM roles
5. Make sure the inline policy was created successfully
`;
            
            const blob = new Blob([instructions], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'costreports360-manual-setup.md';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        async function generateReport() {
            const status = document.getElementById('status');
            status.className = 'status loading';
            status.textContent = 'Generating report... This may take a minute.';
            
            const clientName = document.getElementById('clientName').value.trim();
            const months = getSelectedMonths();
            
            if (!clientName) {
                status.className = 'status error';
                status.textContent = 'Please provide client name';
                return;
            }
            
            if (months.length < 2 || months.length > 6) {
                status.className = 'status error';
                status.textContent = 'Please select 2-6 months';
                return;
            }
            
            const authMethod = document.getElementById('authMethod').value;
            let requestBody = {
                clientName: clientName,
                months: months
            };
            
            if (authMethod === 'credentials') {
                const accessKeyId = document.getElementById('accessKeyId').value;
                const secretAccessKey = document.getElementById('secretAccessKey').value;
                
                if (!accessKeyId || !secretAccessKey) {
                    status.className = 'status error';
                    status.textContent = 'Please provide AWS credentials';
                    return;
                }
                
                requestBody.accessKeyId = accessKeyId;
                requestBody.secretAccessKey = secretAccessKey;
            } else {
                const targetAccountId = document.getElementById('targetAccountId').value;
                
                if (!targetAccountId || !/^[0-9]{12}$/.test(targetAccountId)) {
                    status.className = 'status error';
                    status.textContent = 'Please provide valid 12-digit AWS Account ID';
                    return;
                }
                
                requestBody.targetAccountId = targetAccountId;
            }
            
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const blob = base64ToBlob(data.file, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = data.filename;
                    a.click();
                    status.className = 'status success';
                    status.textContent = 'Report generated successfully!';
                } else {
                    status.className = 'status error';
                    status.textContent = `Error: ${data.message || 'Unknown error'}`;
                }
            } catch (error) {
                status.className = 'status error';
                status.textContent = `Error: ${error.message}`;
            }
        }
        
        function base64ToBlob(base64, type) {
            const binary = atob(base64);
            const array = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                array[i] = binary.charCodeAt(i);
            }
            return new Blob([array], { type });
        }
        
        // Initialize with 2 month selectors
        document.addEventListener('DOMContentLoaded', () => {
            addMonth();
            addMonth();
        });
    </script>
</body>
</html>
