#!/bin/bash
# CostReports360 - Start Server Script
# Starts the local web server on port 5000 and configures auto-start on boot

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SERVICE_NAME="costreports360"
PORT="${PORT:-5000}"
PID_FILE="/tmp/${SERVICE_NAME}.pid"
LOG_FILE="/tmp/${SERVICE_NAME}.log"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_status() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

# Check if server is already running
check_running() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if ps -p "$PID" > /dev/null 2>&1; then
            return 0  # Running
        else
            rm -f "$PID_FILE"
        fi
    fi
    return 1  # Not running
}

# Start the server
start_server() {
    echo ""
    echo "========================================"
    echo "  CostReports360 - Starting Server"
    echo "========================================"
    echo ""

    # Check if already running
    if check_running; then
        PID=$(cat "$PID_FILE")
        print_warning "Server is already running (PID: $PID)"
        echo ""
        echo "  Frontend: http://localhost:$PORT"
        echo "  API:      http://localhost:$PORT/api/generate"
        echo ""
        echo "  To stop:  $SCRIPT_DIR/stop-costapp"
        exit 0
    fi

    # Check for virtual environment and use it if available
    if [ -d "$SCRIPT_DIR/venv" ]; then
        source "$SCRIPT_DIR/venv/bin/activate"
        print_status "Using virtual environment"
        PIP_CMD="pip"
    else
        PIP_CMD="pip3"
    fi

    # Check Python dependencies
    if ! python3 -c "import flask" 2>/dev/null; then
        print_warning "Flask is not installed."
        echo "         Installing dependencies..."
        $PIP_CMD install -r "$SCRIPT_DIR/requirements.txt" -q
        print_status "Dependencies installed"
    fi

    # Start the server in the background with PORT environment variable
    cd "$SCRIPT_DIR"
    PORT=$PORT nohup python3 "$SCRIPT_DIR/server.py" > "$LOG_FILE" 2>&1 &
    SERVER_PID=$!
    echo "$SERVER_PID" > "$PID_FILE"

    # Wait a moment for the server to start
    sleep 2

    # Check if server started successfully
    if ps -p "$SERVER_PID" > /dev/null 2>&1; then
        print_status "Server started successfully (PID: $SERVER_PID)"
        echo ""
        echo "  Frontend: http://localhost:$PORT"
        echo "  API:      http://localhost:$PORT/api/generate"
        echo "  Logs:     $LOG_FILE"
        echo ""
    else
        print_error "Failed to start server. Check logs at $LOG_FILE"
        cat "$LOG_FILE"
        exit 1
    fi

    # Setup auto-start on boot
    setup_autostart
}

# Setup systemd user service for auto-start
setup_autostart() {
    # Check if systemd is available
    if ! command -v systemctl &> /dev/null; then
        print_warning "systemd not available, skipping auto-start setup"
        echo "         You can manually add to your shell startup script:"
        echo "         echo '$SCRIPT_DIR/serve-costapp' >> ~/.bashrc"
        return
    fi

    # Create user systemd directory if it doesn't exist
    SYSTEMD_USER_DIR="$HOME/.config/systemd/user"
    mkdir -p "$SYSTEMD_USER_DIR"

    # Create service file
    SERVICE_FILE="$SYSTEMD_USER_DIR/${SERVICE_NAME}.service"
    
    # Get the Python executable path
    if [ -d "$SCRIPT_DIR/venv" ]; then
        PYTHON_PATH="$SCRIPT_DIR/venv/bin/python3"
    else
        PYTHON_PATH=$(which python3)
    fi

    cat > "$SERVICE_FILE" << EOF
[Unit]
Description=CostReports360 Local Web Server
After=network.target

[Service]
Type=simple
WorkingDirectory=$SCRIPT_DIR
ExecStart=$PYTHON_PATH $SCRIPT_DIR/server.py
Restart=on-failure
RestartSec=5
Environment=PORT=$PORT
Environment=HOST=0.0.0.0

[Install]
WantedBy=default.target
EOF

    # Reload systemd user daemon
    systemctl --user daemon-reload 2>/dev/null || true

    # Enable and start the service
    systemctl --user enable "$SERVICE_NAME" 2>/dev/null || true

    # Enable lingering so services start even without login
    loginctl enable-linger "$USER" 2>/dev/null || true

    print_status "Auto-start on boot configured"
    echo ""
    echo "  Service: systemctl --user status $SERVICE_NAME"
    echo ""
}

# Main execution
start_server
