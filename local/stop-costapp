#!/bin/bash
# CostReports360 - Stop Server Script
# Stops the local web server and disables auto-start on boot

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SERVICE_NAME="costreports360"
PID_FILE="/tmp/${SERVICE_NAME}.pid"
LOG_FILE="/tmp/${SERVICE_NAME}.log"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_status() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

echo ""
echo "========================================"
echo "  CostReports360 - Stopping Server"
echo "========================================"
echo ""

# Stop the systemd service if it exists
if command -v systemctl &> /dev/null; then
    SYSTEMD_USER_DIR="$HOME/.config/systemd/user"
    SERVICE_FILE="$SYSTEMD_USER_DIR/${SERVICE_NAME}.service"
    
    if [ -f "$SERVICE_FILE" ]; then
        # Stop the service
        systemctl --user stop "$SERVICE_NAME" 2>/dev/null || true
        
        # Disable auto-start
        systemctl --user disable "$SERVICE_NAME" 2>/dev/null || true
        
        print_status "Systemd service stopped and disabled"
    fi
fi

# Stop the background process if running
if [ -f "$PID_FILE" ]; then
    PID=$(cat "$PID_FILE")
    if ps -p "$PID" > /dev/null 2>&1; then
        kill "$PID" 2>/dev/null || true
        
        # Wait for process to terminate
        sleep 1
        
        # Force kill if still running
        if ps -p "$PID" > /dev/null 2>&1; then
            kill -9 "$PID" 2>/dev/null || true
        fi
        
        print_status "Server process stopped (PID: $PID)"
    else
        print_warning "Server process was not running"
    fi
    rm -f "$PID_FILE"
else
    # Try to find and kill any running server process
    PIDS=$(pgrep -f "python3.*server.py" 2>/dev/null || true)
    if [ -n "$PIDS" ]; then
        for PID in $PIDS; do
            kill "$PID" 2>/dev/null || true
        done
        print_status "Server process(es) stopped"
    else
        print_warning "No server process found"
    fi
fi

# Cleanup log file if exists
if [ -f "$LOG_FILE" ]; then
    rm -f "$LOG_FILE"
    print_status "Log file cleaned up"
fi

echo ""
echo "Server stopped successfully."
echo ""
echo "To start again: $SCRIPT_DIR/serve-costapp"
echo ""
