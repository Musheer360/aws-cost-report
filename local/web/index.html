<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CostReports360 - Local</title>
    <link href="https://fonts.googleapis.com/css2?family=Amazon+Ember:wght@400;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overscroll-behavior: none;
        }
        
        body {
            font-family: 'Open Sans', 'Amazon Ember', Arial, sans-serif;
            background: linear-gradient(135deg, #23649c 0%, #1a4d78 100%);
            color: #FFFFFF;
            min-height: 100vh;
            padding: 20px;
            overscroll-behavior: none;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            padding: 40px 0;
            border-bottom: 3px solid #FFFFFF;
            margin-bottom: 40px;
        }

        .logo {
            max-width: 200px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 8px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #FFFFFF;
            font-size: 1.1rem;
        }

        .local-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .card {
            background: #FFFFFF;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            color: #23649c;
        }
        
        .card h3 {
            color: #23649c;
            font-size: 1.3rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #23649c;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #23649c;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #D5DBDB;
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s;
            background: #FFFFFF;
            color: #232F3E;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #23649c;
        }
        
        .month-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .month-selector select {
            flex: 1;
        }
        
        .month-selector .remove-btn {
            background: #D13212;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }
        
        .month-selector .remove-btn:hover {
            background: #A02A0F;
        }
        
        .btn {
            background: #23649c;
            color: #FFFFFF;
            border: none;
            padding: 14px 28px;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .btn:hover {
            background: #1a4d78;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(35, 100, 156, 0.3);
        }
        
        .btn-secondary {
            background: #FFFFFF;
            color: #23649c;
            border: 2px solid #23649c;
        }
        
        .btn-secondary:hover {
            background: #f0f0f0;
        }
        
        .btn-generate {
            width: 100%;
            padding: 18px;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #23649c 0%, #1a4d78 100%);
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
        }
        
        .status.success {
            background: #D5F4E6;
            color: #0F5132;
            border: 2px solid #0F5132;
        }
        
        .status.error {
            background: #F8D7DA;
            color: #842029;
            border: 2px solid #842029;
        }
        
        .status.loading {
            background: #FFF3CD;
            color: #664D03;
            border: 2px solid #664D03;
        }
        
        .info-box {
            background: #E8F4F8;
            border-left: 4px solid #23649c;
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
            color: #23649c;
        }
        
        .info-box strong {
            color: #23649c;
        }

        .auth-info {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://apn-portal.my.salesforce.com/servlet/servlet.ImageServer?id=0150L00000AUiBnQAL&oid=00DE0000000c48tMAA" alt="CloudThat Logo" class="logo">
            <h1>CostReports360</h1>
            <p>Generate detailed AWS cost analysis reports with regional breakdowns</p>
            <span class="local-badge">üñ•Ô∏è Running Locally</span>
        </div>
        
        <div class="card">
            <h3>Client Information</h3>
            <div class="form-group">
                <label>Client Name</label>
                <input type="text" id="clientName" placeholder="Example Client" required>
            </div>
        </div>
        
        <div class="card">
            <h3>Select Months (2-6 months)</h3>
            <div id="months-container"></div>
            <button class="btn" onclick="addMonth()">+ Add Month</button>
        </div>
        
        <div class="card">
            <h3>Authentication Method</h3>
            <div class="auth-info">
                <strong>üí° Local Mode:</strong> By default, uses your AWS CLI credentials. You can also enter credentials manually below.
            </div>
            <div class="form-group">
                <label>Choose Method</label>
                <select id="authMethod" onchange="toggleAuthMethod()">
                    <option value="cli">Use AWS CLI Credentials (Default)</option>
                    <option value="credentials">Enter AWS Credentials Manually</option>
                    <option value="role">Cross-Account Role</option>
                </select>
            </div>

            <div id="cliAuth">
                <div class="form-group">
                    <label>AWS Profile (Optional)</label>
                    <input type="text" id="awsProfile" placeholder="default">
                    <small style="color: #666;">Leave empty to use default profile</small>
                </div>
                
                <div class="form-group">
                    <label>AWS Region</label>
                    <input type="text" id="awsRegion" value="us-east-1" placeholder="us-east-1">
                </div>
            </div>

            <div id="credentialsAuth" style="display:none;">
                <div class="form-group">
                    <label>AWS Access Key ID</label>
                    <input type="text" id="accessKeyId" placeholder="AKIAIOSFODNN7EXAMPLE">
                </div>
                
                <div class="form-group">
                    <label>AWS Secret Access Key</label>
                    <input type="password" id="secretAccessKey" placeholder="wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY">
                </div>
            </div>

            <div id="roleAuth" style="display:none;">
                <div class="info-box">
                    <strong>Note:</strong> Cross-account role support requires that your local AWS credentials have permission to assume the target role.
                </div>
                <br>
                <div class="form-group">
                    <label>Role ARN from Target Account</label>
                    <input type="text" id="roleArn" placeholder="arn:aws:iam::123456789012:role/CostReports360ReadOnlyRole">
                </div>
            </div>
        </div>
        
        <div class="card">
            <button class="btn btn-generate" onclick="generateReport()">Generate Report</button>
            <div id="status"></div>
        </div>
    </div>

    <script>
        // Use relative path for local server
        const API_ENDPOINT = '/api/generate';
        
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                       'July', 'August', 'September', 'October', 'November', 'December'];
        
        function createMonthSelector() {
            const div = document.createElement('div');
            div.className = 'month-selector';
            
            const yearSelect = document.createElement('select');
            yearSelect.className = 'year-select';
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= currentYear - 3; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
            
            const monthSelect = document.createElement('select');
            monthSelect.className = 'month-select';
            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = String(index + 1).padStart(2, '0');
                option.textContent = month;
                monthSelect.appendChild(option);
            });
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = '‚úï';
            removeBtn.onclick = function() {
                if (document.querySelectorAll('.month-selector').length > 2) {
                    div.remove();
                } else {
                    alert('Minimum 2 months required');
                }
            };
            
            div.appendChild(yearSelect);
            div.appendChild(monthSelect);
            div.appendChild(removeBtn);
            
            return div;
        }
        
        function addMonth() {
            const container = document.getElementById('months-container');
            if (container.children.length >= 6) {
                alert('Maximum 6 months allowed');
                return;
            }
            container.appendChild(createMonthSelector());
        }
        
        function getSelectedMonths() {
            const selectors = document.querySelectorAll('.month-selector');
            const months = [];
            selectors.forEach(selector => {
                const year = selector.querySelector('.year-select').value;
                const month = selector.querySelector('.month-select').value;
                months.push(`${year}-${month}`);
            });
            return months;
        }
        
        function toggleAuthMethod() {
            const method = document.getElementById('authMethod').value;
            const cliAuth = document.getElementById('cliAuth');
            const credentialsAuth = document.getElementById('credentialsAuth');
            const roleAuth = document.getElementById('roleAuth');
            
            cliAuth.style.display = 'none';
            credentialsAuth.style.display = 'none';
            roleAuth.style.display = 'none';
            
            if (method === 'cli') {
                cliAuth.style.display = 'block';
            } else if (method === 'credentials') {
                credentialsAuth.style.display = 'block';
            } else {
                roleAuth.style.display = 'block';
            }
        }
        
        async function generateReport() {
            const status = document.getElementById('status');
            status.className = 'status loading';
            status.textContent = 'Generating report... This may take a minute.';
            
            const clientName = document.getElementById('clientName').value.trim();
            const months = getSelectedMonths();
            
            if (!clientName) {
                status.className = 'status error';
                status.textContent = 'Please provide client name';
                return;
            }
            
            if (months.length < 2 || months.length > 6) {
                status.className = 'status error';
                status.textContent = 'Please select 2-6 months';
                return;
            }
            
            const authMethod = document.getElementById('authMethod').value;
            let requestBody = {
                clientName: clientName,
                months: months
            };
            
            if (authMethod === 'cli') {
                const profile = document.getElementById('awsProfile').value.trim();
                const region = document.getElementById('awsRegion').value.trim() || 'us-east-1';
                
                if (profile) {
                    requestBody.profile = profile;
                }
                requestBody.region = region;
            } else if (authMethod === 'credentials') {
                const accessKeyId = document.getElementById('accessKeyId').value;
                const secretAccessKey = document.getElementById('secretAccessKey').value;
                
                if (!accessKeyId || !secretAccessKey) {
                    status.className = 'status error';
                    status.textContent = 'Please provide AWS credentials';
                    return;
                }
                
                requestBody.accessKeyId = accessKeyId;
                requestBody.secretAccessKey = secretAccessKey;
            } else {
                const roleArn = document.getElementById('roleArn').value;
                
                if (!roleArn || !roleArn.startsWith('arn:aws:iam::')) {
                    status.className = 'status error';
                    status.textContent = 'Please provide valid Role ARN';
                    return;
                }
                
                requestBody.roleArn = roleArn;
            }
            
            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const blob = base64ToBlob(data.file, 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = data.filename;
                    a.click();
                    status.className = 'status success';
                    status.textContent = 'Report generated successfully!';
                } else {
                    status.className = 'status error';
                    status.textContent = `Error: ${data.message || 'Unknown error'}`;
                }
            } catch (error) {
                status.className = 'status error';
                status.textContent = `Error: ${error.message}`;
            }
        }
        
        function base64ToBlob(base64, type) {
            const binary = atob(base64);
            const array = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                array[i] = binary.charCodeAt(i);
            }
            return new Blob([array], { type });
        }
        
        // Initialize with 2 month selectors
        document.addEventListener('DOMContentLoaded', () => {
            addMonth();
            addMonth();
        });
        
        // Initialize auth method display on page load
        toggleAuthMethod();
    </script>
</body>
</html>
